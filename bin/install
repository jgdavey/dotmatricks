#!/usr/bin/env bash
set -e

source $(dirname $0)/dot_functions.sh

directory_warning

# Copy *.local files
for file in *.local ; do
  dotmatrix_path=$PWD/$file
  path="$HOME/.$file"

  if [ ! -e $path ]; then
    copy_notice $file "absent"
    cp $dotmatrix_path $path
  else
    skip_notice $file "exists"
  fi
done

for file in $(./bin/file_list.sh); do
  dotmatrix_path="$PWD/dotfiles/$file"
  path="$HOME/.$file"

  [ -e $dotmatrix_path ] || continue

  if [ -e "$path" ]; then
    if [ $dotmatrix_path = "$(readlink $path)" ]; then # Symlinked here?
      skip_notice $file "exists"
    else
      skip_notice $file "external"
    fi
  else
    link_notice $file "absent"
    ln -nfs $dotmatrix_path $path
  fi
done

find config -type f -name '*' | while read file; do
  dotmatrix_path="$PWD/${file}"
  path="$HOME/.${file}"

  if [ -e "$path" ]; then
    if [ "$dotmatrix_path" = "$(readlink $path)" ]; then # Symlinked here?
      skip_notice $file "exists"
    else
      skip_notice $file "external"
    fi
  else
    link_notice $file "absent"
    mkdir -p "$(dirname $path)"
    ln -nfs $dotmatrix_path $path
  fi
done

$PWD/jd/bin/jd autoinstall
